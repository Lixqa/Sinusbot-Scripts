registerPlugin({name:"Youtube Search",version:"1.3.0",engine:">= 0.9.17",description:"Youtube video search",author:"NT5",vars:[{name:"yt_apikey",title:"API KEY (https://console.developers.google.com/project)",type:"string"},{name:"ytdl_action",title:"Action with YoutubeDL",type:"select",indent:1,options:["Nothing","Download","Stream"]},{name:"ytdl_playback",title:"Playback action",type:"select",indent:1,options:["Queue","Force play"]},{name:"yt_catchurl",title:"Catch YouTube Links",type:"checkbox"},{name:"yt_maxresults",title:"Max youtube videos (1~>=50)",type:"number",placeholder:"1"},{name:"yt_maxduration",title:"Max youtube video duration for playback (in seconds) default 900seg (15min)",type:"number",placeholder:"900"},{name:"yt_randomplay",title:"Play random video from search (only work if maxresults>=2)",type:"checkbox"},{name:"command_trigger",title:"Command trigger",type:"string",placeholder:"youtube"},{name:"command_message",title:"Message Format (supports bbcode)",type:"multiline",placeholder:"[B]You[/B][COLOR=#ff0000]Tube[/COLOR] - Title: {title} - Link: [url={yt_link}]{yt_link}[/url] - By: {upload_by}"},{name:"yt_titleblacklist",title:"Banned video titles <comma saparated>",type:"string",placeholder:"10 hours, ..."},{name:"command_adminpermissions",title:"Admin users (ID or Name)",type:"array",vars:[{name:"user",type:"string",indent:2,placeholder:"Username or id"}]},{name:"command_blacklistusers",title:"Banned users <comma saparated> ",type:"string",placeholder:"trollface, <id/username>..."},{name:"command_permissionsServerGroups",title:"List of server groups that the bot should accept command and links (ID or Name)",type:"array",vars:[{name:"group",type:"string",indent:2,placeholder:"Group name or id"}]}]},function(a,b){function f(a){var b=a.match(/\d+/g);return a.indexOf("M")>=0&&-1==a.indexOf("H")&&-1==a.indexOf("S")&&(b=[0,b[0],0]),a.indexOf("H")>=0&&-1==a.indexOf("M")&&(b=[b[0],0,b[1]]),a.indexOf("H")>=0&&-1==a.indexOf("M")&&-1==a.indexOf("S")&&(b=[b[0],0,0]),a=0,3==b.length&&(a+=3600*parseInt(b[0]),a+=60*parseInt(b[1]),a+=parseInt(b[2])),2==b.length&&(a+=60*parseInt(b[0]),a+=parseInt(b[1])),1==b.length&&(a+=parseInt(b[0])),a}function g(a){var b=parseInt(a,10),c=Math.floor(b/3600)%24,d=Math.floor(b/60)%60,e=b%60;return"{hours}{minutes}{seconds}".format({hours:c>0?c+"h ":"",minutes:d>0?d+"min ":"",seconds:e>0?e+"secs":""})}function h(a){a+="",x=a.split("."),x1=x[0],x2=x.length>1?"."+x[1]:"";for(var b=/(\d+)(\d{3})/;b.test(x1);)x1=x1.replace(b,"$1,$2");return x1+x2}function i(a,b){var d,c=[];for(d in a)if(a.hasOwnProperty(d)){var e=b?b+"["+d+"]":d,f=a[d];c.push(null!==f&&"object"==typeof f?i(f,e):encodeURIComponent(e)+"="+encodeURIComponent(f))}return c.join("&")}var c=require("backend"),d=require("engine"),e=require("event");String.prototype.format||(String.prototype.format=function(){var a=this.toString();if(!arguments.length)return a;var b=typeof arguments[0],b="string"==b||"number"==b?arguments:arguments[0];for(arg in b)a=a.replace(RegExp("\\{"+arg+"\\}","gi"),b[arg]);return a}),String.prototype.trunc=function(a,b){if(this.length<=a)return this;var c=this.substr(0,a-1);return(b?c.substr(0,c.lastIndexOf(" ")):c)+"..."},"function"!=typeof Object.assign&&(Object.assign=function(a,b){"use strict";if(null==a)throw new TypeError("Cannot convert undefined or null to object");for(var c=Object(a),d=1;d<arguments.length;d++){var e=arguments[d];if(null!=e)for(var f in e)Object.prototype.hasOwnProperty.call(e,f)&&(c[f]=e[f])}return c});var j={config:{api:{url:"https://www.googleapis.com/youtube/v3/{path}?{fields}",key:b.yt_apikey||0,maxresults:function(){var a=parseInt(b.yt_maxresults);return a>=1&&a<=50?a:1}()},plugin:{regex:{cmd:/^\!(\w+)(?:\-(\w+))?(?:\s(.+))?/,youtube:/(?:http|https)\:\/\/www\.(?:youtube\.com|youtu\.be)\/watch\?v\=([\w\-]+)/},command_trigger:b.command_trigger||"youtube",catch_url:b.yt_catchurl,randomplay:b.yt_randomplay,yt_maxduration:b.yt_maxduration||900,yt_titleblacklist:void 0!==b.yt_titleblacklist&&b.yt_titleblacklist.length>0?b.yt_titleblacklist.split(","):[],command_message:b.command_message||"[B]You[/B][COLOR=#ff0000]Tube[/COLOR] - Title: {title} - Link: [url={yt_link}]{yt_link}[/url] - By: {upload_by}",ytdl_action:parseInt(b.ytdl_action)||0,ytdl_playback:parseInt(b.ytdl_playback)||0,server_groups:b.command_permissionsServerGroups||[],adminpermissions:b.command_adminpermissions||[],blacklistusers:void 0!==b.command_blacklistusers&&b.command_blacklistusers.length>0?b.command_blacklistusers.split(","):[]}},getJSON:function(b){b="object"!=typeof b?{}:b,b.method=b.method||"GET",b.url=b.url||"",b.headers=b.headers||{"Content-Type":"application/json; charset=UTF-8"},b.callback=b.callback||function(a,b){d.log(b)},b.error_callback=b.error_callback||function(a,b){d.log(a)},a.http({method:b.method,url:b.url,headers:b.headers},function(a,c){if(a||200!=c.statusCode)d.log("Request error [{error}] Code: [{code}] Data: [{data}]".format({error:a,data:c.data,code:c.statusCode})),b.error_callback(a);else{var e=JSON.parse(c.data);b.callback(e)}})},api:{search:function(a){a="object"!=typeof a?{}:a,a.query=a.query||"",a.maxresults=a.maxresults||j.config.api.maxresults,a.type=a.type||"video",a.fields=a.fields||"items(snippet/title,snippet/description,snippet/channelTitle,id)",a.part=a.part||"snippet",a.api_key=a.api_key||j.config.api.key,a.callback=a.callback||function(a){d.log(a)},a.error_callback=a.error_callback||function(a){d.log(a)},j.getJSON({url:j.config.api.url.format({path:"search",fields:i({q:a.query,part:a.part,type:a.type,maxResults:a.maxresults,fields:a.fields,key:a.api_key})}),callback:a.callback,error_callback:a.error_callback})},video:function(a){a="object"!=typeof a?{}:a,a.videoId=a.videoId||0,a.fields=a.fields||"items(snippet/title,snippet/description,snippet/channelTitle,id,kind,statistics,contentDetails/duration)",a.part=a.part||"snippet,statistics,contentDetails",a.api_key=a.api_key||j.config.api.key,a.callback=a.callback||function(a){d.log(a)},a.error_callback=a.error_callback||function(a){d.log(a)},j.getJSON({url:j.config.api.url.format({path:"videos",fields:i({id:a.videoId,part:a.part,fields:a.fields,key:a.api_key})}),callback:a.callback,error_callback:a.error_callback})}},msg:function(a){a="object"!=typeof a?{}:a,a.text=a.text||"ravioli ravioli",a.mode=a.mode||0,a.backend=a.backend||c,a.client=a.client||!1,a.channel=a.channel||!1;var b=1e3,d=125;switch(a.mode){case 1:a.client?a.text.length>=b?(a.client.chat(a.text.trunc(b)),a.text=a.text.slice(b,a.text.length),setTimeout(function(){j.msg(a)},d)):a.client.chat(a.text):(a.mode=0,j.msg(a));break;case 2:a.channel?a.text.length>b?(a.channel.chat(a.text.trunc(b)),a.text=a.text.slice(b,a.text.length),setTimeout(function(){j.msg(a)},d)):a.channel.chat(a.text):(a.mode=0,j.msg(a));break;default:a.text.length>b?(a.backend.chat(a.text.trunc(b)),a.text=a.text.slice(b,a.text.length),setTimeout(function(){j.msg(a)},d)):a.backend.chat(a.text)}},commands:{youtube:{syntax:"Syntax: !{cmd}-[{valids}] [<text>]",active:!0,hidden:!0,admin:!1,callback:function(a){a="object"!=typeof a?{}:a;var b=function(b){j.msg(Object.assign(a,{text:b}))},c=function(a){b("Search failed (Bad request)"),d.log(a)};j.api.search({query:a.text,fields:"items(id)",callback:function(d){if(d="object"!=typeof d?{}:d,d.items=d.items||[],d.items.length<=0)b("Search failed (Nothing found)");else{var e=!1,f=d.items;f.forEach(function(b){b="object"!=typeof b?{}:b,b.id=b.id||{},b.id.videoId=b.id.videoId||0,b.id.kind=b.id.kind||"default",j.api.video({videoId:b.id.videoId,callback:function(b){var c=!j.config.plugin.randomplay||Math.random()>=1-1/f.length;j.callbacks.video_message({msg:a,video:b}),e||f[f.length-1].id.videoId!==b.items[0].id?!e&&c&&j.callbacks.video_playback({video:b})&&(e=!0):j.callbacks.video_playback({video:b})?e=!0:j.msg(Object.assign(a,{text:"Could not play video with filters set",mode:1}))},error_callback:c})})}},error_callback:c})}},video:{syntax:"Syntax !{cmd}-{par} <video-id/link>",active:!0,hidden:!1,admin:!1,callback:function(a){var b=function(b){j.msg(Object.assign(a,{text:b}))},c=require("format"),d=[[c.bold("You"),c.color("Tube","#ff0000")," "].join(""),[[c.bold("Title:"),"{title}"].join(" "),[c.bold("Link:"),"[url={yt_link}]{yt_link}[/url]"].join(" "),[c.bold("Duration:"),"{duration}"].join(" "),[c.bold("Views:"),"{viewCount}"].join(" "),[c.bold("Likes:"),"{likeCount}"].join(" "),[c.bold("Dislikes:"),"{dislikeCount}"].join(" "),[c.bold("Comments:"),"{commentCount}"].join(" "),[c.bold("By:"),"{upload_by}"].join(" "),[c.bold("Description:"),"{description_complete}"].join(" ")].join(" - ")],e=j.config.plugin.regex.youtube.exec(a.text)||a.text;j.api.video({videoId:"object"==typeof e?e[1]:e,callback:function(b){j.callbacks.video_message({msg:a,message_format:d.join(""),video:b})},error_callback:function(a){b("Search failed (Bad request)")}})}},search:{syntax:"Syntax !{cmd}-{par} <text>",active:!0,hidden:!1,admin:!1,callback:function(a){var b=function(b){j.msg(Object.assign(a,{text:b}))},c=require("format"),e=[[c.bold("You"),c.color("Tube","#ff0000")," "].join(""),[[c.bold("Title:"),"{title}"].join(" "),[c.bold("Link:"),"[url={yt_link}]{yt_link}[/url]"].join(" "),[c.bold("Description:"),"{description}"].join(" "),[c.bold("by:"),"{upload_by}"].join(" ")].join(" - ")];j.api.search({query:a.text,maxresults:5,callback:function(b){b="object"!=typeof b?{}:b,b.items=b.items||[],b.items.forEach(function(b){d.log(b),b="object"!=typeof b?{}:b,b.id=b.id||{},b.id.videoId=b.id.videoId||0,b.id.kind=b.id.kind||"default",j.callbacks.video_message({msg:a,message_format:e.join(""),video:{items:[{id:b.id.videoId,kind:b.id.kind,snippet:b.snippet}]}})})},error_callback:function(a){b("Search failed (Bad request)")}})}},about:{syntax:!1,active:!0,hidden:!1,admin:!1,callback:function(a){var b=c.getBotClient();j.msg(Object.assign(a,{text:"Youtube Search script v{version} by {author} running on {bot_name}".format({version:"1.3.0",author:"NT5",bot_name:b.name()})}))}},setkey:{syntax:"Syntax !{cmd}-{par} <key>",active:!0,hidden:!1,admin:!0,callback:function(a){a="object"!=typeof a?{}:a,a.mode=1;var c=j.config.api.key;j.config.api.key=a.text,b.yt_apikey=j.config.api.key,d.saveConfig(b),j.msg(Object.assign(a,{text:"Api Key renewed from {old_key} to {key}".format({key:j.config.api.key,old_key:c})}))}},reset:{syntax:"Syntax !{cmd}-{par} {botname}",active:!0,hidden:!1,admin:!0,callback:function(a){var e=function(b){j.msg(Object.assign(a,{text:b}))},f=c.getBotClient();a.text===f.name()?(b={},d.saveConfig(b),d.reloadScripts()||e("Can't reload script because its disabled in config.ini"),e('All configuration reset to default. If not take effect make sure do you have activate "AllowReload" on your config.ini or reload it manually')):e("You should type the bot name to reset settings")}},test:{syntax:!1,active:!0,hidden:!0,admin:!0,callback:function(b){b="object"!=typeof b?{}:b,j.msg(Object.assign(b,{text:"{0}".format(c.getBotClient().uniqueID())})),d.log(a)}},getCommands:function(){var a=[];return Object.keys(j.commands).forEach(function(b){var c=j.commands[b];c.active&&!c.hidden&&a.push(b)}),a||!1}},callbacks:{video_message:function(a){a="object"!=typeof a?{}:a,a.video=a.video||{},a.msg=a.msg||{},a.message_format=a.message_format||j.config.plugin.command_message;var b=function(b){j.msg(Object.assign(a.msg,{text:b}))};if(a.video.items=a.video.items||[],a.video.items.forEach(function(a){a="object"!=typeof a?{}:a,a.kind=a.kind||"default",a.id=a.id||0,a.snippet=a.snippet||{},a.snippet.title=a.snippet.title||"no video",a.snippet.description=a.snippet.description||"no video",a.snippet.channelTitle=a.snippet.channelTitle||"no video",a.contentDetails=a.contentDetails||{},a.contentDetails.duration=a.contentDetails.duration||"0S",a.statistics=a.statistics||{},a.statistics.commentCount=a.statistics.commentCount||0,a.statistics.viewCount=a.statistics.viewCount||0,a.statistics.likeCount=a.statistics.likeCount||0,a.statistics.dislikeCount=a.statistics.dislikeCount||0,a.statistics.favoriteCount=a.statistics.favoriteCount||0}),a.video.items.length>0){var c=a.video.items[0];if("youtube#video"===c.kind){var i={title:c.snippet.title,description_complete:c.snippet.description,description:c.snippet.description.trunc(160),video_id:c.id,yt_link:"http://www.youtube.com/watch?v={0}".format(c.id),upload_by:c.snippet.channelTitle,duration:g(f(c.contentDetails.duration)),commentCount:h(c.statistics.commentCount),viewCount:h(c.statistics.viewCount),likeCount:h(c.statistics.likeCount),dislikeCount:h(c.statistics.dislikeCount),favoriteCount:h(c.statistics.favoriteCount)};b(a.message_format.format(i))}else b("Search failed (Invalid type)"),d.log(a.video)}else b("Search failed (Nothing found)")},video_playback:function(b){if(b="object"!=typeof b?{}:b,b.video=b.video||{},b.video.items=b.video.items||[],b.video.items.forEach(function(a){a="object"!=typeof a?{}:a,a.kind=a.kind||"default",a.id=a.id||0,a.snippet=a.snippet||{},a.snippet.title=a.snippet.title||"no video",a.contentDetails=a.contentDetails||{},a.contentDetails.duration=a.contentDetails.duration||"0S"}),b.video.items.length>0){var c=require("media"),e=b.video.items[0],g={title:function(){var a=e.snippet.title.toLowerCase(),b=!1;return j.config.plugin.yt_titleblacklist.forEach(function(c){b||-1===a.indexOf(c.toLowerCase())||(b=!0)}),!b},duration:function(){return f(e.contentDetails.duration)<=j.config.plugin.yt_maxduration}};if(!g.title()||!g.duration())return!1;var h=e.id,i=0===j.config.plugin.ytdl_playback;switch(j.config.plugin.ytdl_action){case 1:return c.ytdl(h,!i)?d.log("Donwload: "+h):d.log("Can't download: "+h),i&&(a.qyt(h)?d.log("Append to queue: "+h):d.log("Cannot enqueue: "+h)),!0;case 2:return i?a.qyt(h)?d.log("Append to queue: "+h):d.log("Cannot enqueue: "+h):c.yt(h)?d.log("Streaming: "+h):d.log("Can't Streaming: "+h),!0;default:return!0}}return!1}}};e.on("chat",function(a){var b=a.client,d=a.channel,e=c.getBotClient();if(!b.isSelf()){var f={config:{group:j.config.plugin.server_groups.map(function(a){return a.group}),client:j.config.plugin.adminpermissions.map(function(a){return a.user}),banned:j.config.plugin.blacklistusers},group:{has_permission:function(){if(f.config.group.length>0){var a=!1;return b.getServerGroups().forEach(function(b){!a&&(f.config.group.indexOf(b.name())>-1||f.config.group.indexOf(b.id())>-1)&&(a=!0)}),a}return!0}},client:{is_banned:function(){return f.config.banned.length>0&&(f.config.banned.indexOf(b.name())>-1||f.config.banned.indexOf(b.uniqueID())>-1)},is_admin:function(){return f.config.client.length>0&&(f.config.client.indexOf(b.name())>-1||f.config.client.indexOf(b.uniqueID())>-1)}}};if(f.group.has_permission()&&!f.client.is_banned()){var i,k,l,g=j.commands.youtube,h={mode:a.mode,client:b,channel:d};if(null!==(l=j.config.plugin.regex.cmd.exec(a.text))){if(i=l[1].toLowerCase(),k=l[2],l=l[3],i===j.config.plugin.command_trigger.toLowerCase()&&g.active)if(k)if((k=k.toLocaleLowerCase())in j.commands)if("callback"in j.commands[k]&&"function"==typeof j.commands[k].callback){var m=j.commands[k];if(!m.active)return;if(m.admin&&!f.client.is_admin())return void j.msg(Object.assign(h,{text:"You not have enough permissions"}));m.syntax?l?m.callback(Object.assign({text:l},h)):j.msg(Object.assign({text:m.syntax.format({cmd:i,par:k,botname:e.name()})},h)):m.callback(h)}else j.msg(Object.assign({text:"Invalid command !{cmd}-{par} not have a valid callback".format({cmd:i,par:k})},h));else j.msg(Object.assign({text:"Invalid command !{cmd}-{par}. Valid commands: !{cmd}-[{valids}]".format({cmd:i,par:k,valids:j.commands.getCommands()})},h));else l?g.callback(Object.assign({text:l},h)):j.msg(Object.assign({text:g.syntax.format({cmd:i,valids:j.commands.getCommands()})},h))}else{var n;j.config.plugin.catch_url&&null!==(n=j.config.plugin.regex.youtube.exec(a.text))&&(n=n[1],j.api.video({videoId:n,callback:function(a){j.callbacks.video_message({video:a,msg:h}),2===h.mode&&j.callbacks.video_playback({video:a})},error_callback:function(a){j.msg(Object.assign(h,{text:"Invalid request (Bad request)"}))}}))}}}}),e.on("unload",function(){d.log(b)})});